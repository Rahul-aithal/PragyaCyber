import { asyncHandler } from "../utils/asyncHandlers";
import { ApiResponse } from "../utils/ApiResponse";
import { ApiError } from "../utils/ApiError";
import { Request, Response } from "express";
import vulnerabilityDetailType, {
  vulnerabilityDetailSchema,
} from "../types/vulnerabillityDetails.type";
import VulnerabilityDetail from "../models/VulnerabilityDetail.model";
import Report from "../models/Report.model";

// Get all the required values for vulnerability details
// Parse for checking all the values
// Then Create a document
// Return ID of the Doc
const createVulnerabilityDetails = asyncHandler(
  async (req: Request, res: Response) => {
    const {
      name,
      cvssScore,
      desc,
      evidences,
      impacts,
      mitigations,
      type,
    }: vulnerabilityDetailType = req.body;
    const reportId = res.locals.report;
    await vulnerabilityDetailSchema.parseAsync({
      name,
      cvssScore,
      desc,
      evidences,
      impacts,
      mitigations,
      type,
    });

    const vulnerability = await VulnerabilityDetail.create({
      name,
      cvssScore,
      desc,
      evidences,
      impacts,
      mitigations,
      type,
    });

    await vulnerability.save();
    await Report.findByIdAndUpdate(
      { reportId },
      {
        $push: { [type]: vulnerability._id },
      },
      {
        new: true,
      }
    );

    res.status(200).json(new ApiResponse(200, vulnerability._id, "Success"));
  }
);

// Get all the required values for vulnerability details, With Id
// Parse for checking all the values and for id
// Then Update the document
// Return ID of the Doc
const updateVulnerabilityDetails = asyncHandler(
  async (req: Request, res: Response) => {
    const {
      name,
      cvssScore,
      desc,
      evidences,
      impacts,
      mitigations,
      type,
      id,
    }: vulnerabilityDetailType & { id: string } = req.body;

    const reportId = res.locals.report;

    if (!id) {
      throw new ApiError(400, "⚠️ Id not found");
    }

    const oldVulnerabilityDetail = await VulnerabilityDetail.findByIdAndUpdate(
      { _id: id },
      {
        $set: {
          name,
          cvssScore,
          desc,
          evidences,
          impacts,
          mitigations,
          type,
        },
      }
    );
    if (!oldVulnerabilityDetail) {
      throw new ApiError(404, "The VulnerabilityDetail doc is not found");
    }
    if (type) {
      await Report.findByIdAndUpdate(
        { reportId },
        {
          $pullAll: { [`${oldVulnerabilityDetail.type}`]: id },
          $push: { [type]: id },
        },
        {
          new: true,
        }
      );
    }

    res.status(200).json(new ApiResponse(200, id, "Success"));
  }
);

// Get ID
// Then Delete the document, else throw err
// Return ID of the Doc
const deleteVulnerabilityDetails = asyncHandler(
  async (req: Request, res: Response) => {
    const { id }: { id: string } = req.body;

    if (!id) {
      throw new ApiError(400, "⚠️ Id not found");
    }

    const vulenrabilityDetails = await VulnerabilityDetail.findByIdAndDelete({
      _id: id,
    });

    if (!vulenrabilityDetails) {
      throw new ApiError(404, "This file is not found");
    }
    const reportId = res.locals.report;

    await Report.findByIdAndUpdate(
      { reportId },
      {
        $pullAll: { [`${vulenrabilityDetails.type}`]: id },
      },
      {
        new: true,
      }
    );

    res.status(200).json(new ApiResponse(200, id, "Success"));
  }
);

export {
  createVulnerabilityDetails,
  updateVulnerabilityDetails,
  deleteVulnerabilityDetails,
};
